<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>कर्मचारी कामगिरी अहवाल</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-bg: #f4f7fc; --card-bg: #ffffff; --header-bg: #0d47a1; --primary-color: #1976d2; --accent-color: #42a5f5; --text-dark: #2c3e50; --text-light: #566573; --border-color: #e0e0e0; --shadow: 0 4px 20px rgba(0, 0, 0, 0.05); --positive-color: #27ae60; --negative-color: #e74c3c; --neutral-color: #f39c12; --highlight-bg: #e3f2fd;
    }
    body { font-family: 'Inter', 'Noto Sans Devanagari', sans-serif; background: var(--primary-bg); margin: 0; color: var(--text-dark); }
    .loader { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; gap: 15px; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    header { background: var(--header-bg); padding: 20px 30px; color: white; text-align: center; font-size: 24px; font-weight: 600; }
    .main-container { padding: 25px; max-width: 1600px; margin: 0 auto; }
    .card { background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 25px; border-top: 4px solid var(--primary-color); }
    .card h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; font-size: 20px; color: var(--header-bg); }
    .filters-grid, .individual-filters, .calendar-filters { display: grid; gap: 20px; align-items: flex-end; }
    .filters-grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .individual-filters { grid-template-columns: 2fr 1fr; }
    .calendar-filters { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .filter-group { display: flex; flex-direction: column; gap: 8px; }
    label { font-weight: 600; font-size: 14px; color: var(--text-light); }
    input[type="date"], select, button { border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 8px; font-family: 'Inter', 'Noto Sans Devanagari', sans-serif; font-size: 15px; width: 100%; box-sizing: border-box; transition: all 0.2s ease; }
    input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); }
    button { background-color: var(--primary-color); color: white; border: none; font-weight: 600; cursor: pointer; }
    button:hover { background-color: var(--header-bg); transform: translateY(-2px); }
    #report-output { margin-top: 30px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th, td { padding: 14px 18px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--border-color); }
    th { background: #f8f9fa; font-weight: 600; color: var(--text-light); }
    tbody tr:nth-child(even) { background-color: #fafcff; }
    tbody tr:hover { background-color: var(--highlight-bg); }
    #individual-analysis-result { margin-top: 30px; }
    .kpi-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .kpi-card { background: #fdfdff; border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 16px; }
    .kpi-card .icon { width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center; flex-shrink: 0; }
    .kpi-card .icon svg { width: 24px; height: 24px; }
    .kpi-card .value { font-size: 28px; font-weight: 700; color: var(--text-dark); }
    .kpi-card .title { font-size: 14px; color: var(--text-light); }
    .opinion-card { background: var(--highlight-bg); padding: 25px; border-radius: 12px; border-left: 5px solid var(--accent-color); }
    .opinion-card h4 { margin-top: 0; display: flex; align-items: center; gap: 10px; color: var(--primary-color); }
    .opinion-card p { font-size: 15px; line-height: 1.7; }
    /* Calendar Styles */
    #calendar-container { margin-top: 30px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { border-radius: 8px; text-align: center; padding: 15px 10px; font-weight: 600; font-size: 16px; border: 1px solid var(--border-color); }
    .day-header { background-color: #f8f9fa; color: var(--text-light); font-weight: 700; padding: 10px; }
    .empty { background-color: transparent; border: none; }
    .reported { background-color: #e6f9f0; color: var(--positive-color); border-color: #a3e9c1; cursor: pointer; transition: transform 0.2s; }
    .reported:hover { transform: scale(1.05); box-shadow: var(--shadow); }
    .missed { background-color: #fff0f0; color: var(--negative-color); border-color: #f5b7b1; }
    .leave { background-color: #fff5e6; color: var(--neutral-color); border-color: #fad7a0; }
    .calendar-legend { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-end; margin-bottom: 15px; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-light); }
    .legend-color { width: 16px; height: 16px; border-radius: 4px; display: inline-block; border: 1px solid var(--border-color); }
    /* Modal Styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; position: relative; }
    .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
    .modal-content h4 { margin-top: 0; color: var(--header-bg); }
    .report-details-list { list-style: none; padding: 0; }
    .report-details-list li { padding: 10px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .report-details-list li:last-child { border-bottom: none; }
    .report-details-list strong { color: var(--text-light); flex-basis: 40%; }
    .report-details-list span { color: var(--text-dark); font-weight: 500; flex-basis: 55%; text-align: right; }
    
    @media (max-width: 768px) { .filters-grid, .individual-filters, .calendar-filters { grid-template-columns: 1fr; } header { font-size: 20px; } .card { padding: 20px; } .calendar-legend { justify-content: center; } }
</style>
</head>
<body>

<header>कर्मचारी कामगिरी अहवाल (Performance Report)</header>

<div class="main-container">
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p>संस्थेचा डेटा लोड होत आहे, कृपया प्रतीक्षा करा...</p>
    </div>

    <div id="content" style="display: none;">
        <div class="card">
            <h3><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>सामूहिक कामगिरी अहवाल</h3>
            <div class="filters-grid">
                <div class="filter-group"><label for="startDate">पासून:</label><input type="date" id="startDate"></div>
                <div class="filter-group"><label for="endDate">पर्यंत:</label><input type="date" id="endDate"></div>
                <div class="filter-group"><label for="branchFilter">युनिट / शाखा:</label><select id="branchFilter"><option value="ALL">सर्व शाखा</option></select></div>
                <div class="filter-group"><label for="roleFilter">स्टाफचा प्रकार:</label><select id="roleFilter"><option value="CA">CA (क्रेडिट)</option><option value="FX">FX (फील्ड)</option><option value="BM">BM (मॅनेजर)</option><option value="TA">TA (अकाऊंटंट)</option></select></div>
                <button onclick="generateCollectiveReport()">अहवाल तयार करा</button>
            </div>
            <div id="report-output"></div>
        </div>

        <div class="card">
            <h3><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>वैयक्तिक कामगिरी विश्लेषण</h3>
            <div class="individual-filters">
                <div class="filter-group"><label for="staffNameFilter">कर्मचारी निवडा:</label><select id="staffNameFilter"><option value="">-- कर्मचारी निवडा --</option></select></div>
                <button onclick="generateIndividualAnalysis()">विश्लेषण करा</button>
            </div>
            <div id="individual-analysis-result"></div>
        </div>
        
        <div class="card">
            <h3><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>वैयक्तिक अहवाल कॅलेंडर</h3>
            <div class="calendar-filters">
                <div class="filter-group"><label for="staffNameCalendarFilter">कर्मचारी निवडा:</label><select id="staffNameCalendarFilter"><option value="">-- कर्मचारी निवडा --</option></select></div>
                <div class="filter-group"><label for="calendarStartDate">पासून:</label><input type="date" id="calendarStartDate"></div>
                <div class="filter-group"><label for="calendarEndDate">पर्यंत:</label><input type="date" id="calendarEndDate"></div>
                <button onclick="generateCalendar()">कॅलेंडर तयार करा</button>
            </div>
            <div id="calendar-container"></div>
        </div>
    </div>
</div>

<div id="reportModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation();">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div id="modal-body"></div>
    </div>
</div>

<script>
const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
const SHEET_ID = "1or7yTCZLhu1qdTijEBC--9lHsigVb3yy1nY-qByHIGY";
const STAFF_SHEET = "StaffList";
const REPORTS_SHEET = "Reports";
const appState = { allStaff: [], allReports: [], dataLoaded: false };

const reportHeaders = [
    "Timestamp", "तारीख", "नाव", "शाखा", "रजेवर?", "पद", "भेटीचे ठिकाण (CA)", "नियमित कलेक्शन रक्कम (CA)",
    "नियमित कलेक्शन सदस्य (CA)", "OD/पास्ट ड्यु रक्कम (CA)", "OD/पास्ट ड्यु सदस्य (CA)", "एकूण बैठका (CA)", "नवीन सदस्य निवड (CA)",
    "भरलेले फॉर्म (CA)", "अॅप्रोयझल संख्या (FX)", "इतर काम (FX)", "रिकव्हरी मदत (FX)", "पास्ट ड्यु खाती (FX)",
    "पास्ट ड्यु रक्कम (FX)", "इतर माहिती (FX)", "वाटप सदस्य (BM)", "वाटप रक्कम (BM)", "अॅप्रायझल मंजूर (BM)", "अॅप्रायझल रद्द (BM)", 
    "सेव्हिंग कलेक्शन (BM)", "नियमित कलेक्शन (BM)", "OD/पास्ट ड्यु कलेक्शन (BM)", "एकूण कलेक्शन (BM)", "इतर कलेक्शन (BM)", "खर्च (BM)",
    "बँक डिपॉझिट (BM)", "गुंतवणूक (रक्कम) (BM)", "अॅनालिसिस रिपोर्ट्स (TA)", "कलेक्शन मॅच? (TA)", "शेरा (TA)",
    "फायनान्स सिस्टीम अपडेट? (TA)", "SPMB अपडेट? (TA)", "रिकव्हरी ट्रॅकर पाठवले? (TA)"
];

window.onload = async function() {
    try {
        const [staffRes, reportRes] = await Promise.all([
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${STAFF_SHEET}?key=${API_KEY}`),
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${REPORTS_SHEET}?key=${API_KEY}`)
        ]);
        if (!staffRes.ok) throw new Error(`Staff list API call failed: ${staffRes.status}. Please check sheet sharing settings.`);
        if (!reportRes.ok) throw new Error(`Reports list API call failed: ${reportRes.status}.`);
        
        const staffData = await staffRes.json();
        const reportData = await reportRes.json();
        
        appState.allStaff = staffData.values ? staffData.values.slice(1).filter(s => s[0] && s[0].trim() !== '') : [];
        appState.allReports = reportData.values ? reportData.values.slice(1).map(createReportObject).filter(r => r.name) : [];
        
        populateFilters();
        appState.dataLoaded = true;
        document.getElementById('loader').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('startDate').valueAsDate = firstDay;
        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('calendarStartDate').valueAsDate = firstDay;
        document.getElementById('calendarEndDate').valueAsDate = today;

    } catch (error) {
        console.error("Error loading data:", error);
        document.getElementById('loader').innerHTML = `<p style="color:red; text-align:center;">डेटा लोड करण्यात अयशस्वी: ${error.message}<br>तुमच्या गूगल शीटची 'Share' सेटिंग 'Anyone with the link' आहे का, हे तपासा.</p>`;
    }
};

function populateFilters() {
    const branches = [...new Set(appState.allStaff.map(row => row[1]))].filter(Boolean).sort();
    const branchFilter = document.getElementById('branchFilter');
    branches.forEach(branch => { branchFilter.innerHTML += `<option value="${branch.toUpperCase()}">${branch}</option>`; });

    const staffByBranch = appState.allStaff.reduce((acc, staff) => {
        const branch = staff[1] || 'Uncategorized';
        if (!acc[branch]) acc[branch] = [];
        acc[branch].push(staff[0]);
        return acc;
    }, {});

    const staffNameFilter = document.getElementById('staffNameFilter');
    const staffNameCalendarFilter = document.getElementById('staffNameCalendarFilter');
    staffNameFilter.innerHTML = `<option value="">-- कर्मचारी निवडा --</option>`;
    staffNameCalendarFilter.innerHTML = `<option value="">-- कर्मचारी निवडा --</option>`;

    for (const branch of Object.keys(staffByBranch).sort()) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = branch;
        staffByBranch[branch].sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            optgroup.appendChild(option);
        });
        staffNameFilter.appendChild(optgroup.cloneNode(true));
        staffNameCalendarFilter.appendChild(optgroup);
    }
}

function createReportObject(r){
    const obj = { fullData: r };
    obj.date = r[1]; obj.name = r[2]; obj.branch = r[3]; obj.leave = r[4]; obj.role = r[5];
    obj.ca_reg_amt=r[7]; obj.ca_odpast_amt=r[9]; obj.ca_meeting_count=r[11]; obj.ca_member_selection=r[12]; obj.ca_forms_filled=r[13];
    obj.fx_appraisal_count=r[14]; obj.fx_recovery_help=r[16]; obj.fx_pastdue_count=r[17]; obj.fx_pastdue_amt=r[18];
    obj.bm_disburse_members=r[20]; obj.bm_disburse_amt=r[21]; obj.bm_appraisal_approved=r[22]; obj.bm_appraisal_rejected=r[23];
    obj.bm_coll_total=r[27]; obj.bm_investment_amt=r[31];
    obj.ta_analysis_reports=r[32]; obj.ta_coll_match=r[33]; obj.ta_finance_update=r[35]; obj.ta_spmb_update=r[36]; obj.ta_recovery_tracker=r[37];
    return obj;
}

function generateCollectiveReport() {
    if (!appState.dataLoaded) return;
    const { start, end } = getValidatedDates('startDate', 'endDate');
    if (!start || !end) return;

    const selectedBranch = document.getElementById('branchFilter').value;
    const selectedRole = document.getElementById('roleFilter').value;
    const outputDiv = document.getElementById('report-output');
    
    const filteredStaff = appState.allStaff.filter(s => (selectedBranch === "ALL" || (s[1] && s[1].toUpperCase() === selectedBranch)) && (s[2] && s[2].toUpperCase() === selectedRole));
    if (filteredStaff.length === 0) { outputDiv.innerHTML = `<p style="text-align:center; padding: 20px;">या निकषांमध्ये कोणताही कर्मचारी सापडला नाही.</p>`; return; }
    
    const filteredReports = appState.allReports.filter(r => { const d = parseSheetDate(r.date); return d && d >= start && d <= end; });
    
    let tableHTML = `<h4>${selectedRole} - कामगिरी अहवाल (${start.toLocaleDateString('en-IN')} ते ${end.toLocaleDateString('en-IN')})</h4><table>`;
    let headers = ['कर्मचारी'];
    
    switch(selectedRole) {
        case 'CA': headers.push('एकूण कलेक्शन (रु.)', 'एकूण बैठका', 'नवीन सदस्य', 'भरलेले फॉर्म'); break;
        case 'FX': headers.push('एकूण अॅप्रोयझल', 'पास्ट डयु कलेक्शन (रु/खाती)', 'रिकव्हरी मदत'); break;
        case 'BM': headers.push('एकूण वाटप (रु/सदस्य)', 'एकूण कलेक्शन (रु.)', 'अॅप्रायझल (मंजूर/रद्द)', 'गुंतवणूक (रु.)'); break;
        case 'TA': headers.push('अॅनालिसिस रिपोर्ट्स', 'कलेक्शन मॅच (होय/नाही)', 'सिस्टीम अपडेट्स', 'रिकव्हरी ट्रॅकर (होय)'); break;
    }
    tableHTML += `<thead><tr><th>${headers.join('</th><th>')}</th></tr></thead><tbody>`;

    filteredStaff.forEach(staff => {
        const staffReports = filteredReports.filter(r => r.name === staff[0] && (r.leave || '').trim().toLowerCase() !== 'होय');
        let row = `<tr><td>${staff[0]}</td>`;

        switch(selectedRole) {
            case 'CA':
                const ca = staffReports.reduce((a, r) => { a.coll += parseFloat(r.ca_reg_amt || 0) + parseFloat(r.ca_odpast_amt || 0); a.meets += parseInt(r.ca_meeting_count || 0); a.mems += parseInt(r.ca_member_selection || 0); a.forms += parseInt(r.ca_forms_filled || 0); return a; }, { coll: 0, meets: 0, mems: 0, forms: 0 });
                row += `<td>${formatCurrency(ca.coll)}</td><td>${ca.meets}</td><td>${ca.mems}</td><td>${ca.forms}</td>`; break;
            case 'FX':
                const fx = staffReports.reduce((a, r) => { a.appr += parseInt(r.fx_appraisal_count || 0); a.past_amt += parseFloat(r.fx_pastdue_amt || 0); a.past_cnt += parseInt(r.fx_pastdue_count || 0); a.help += ((r.fx_recovery_help || '').trim() && r.fx_recovery_help.toLowerCase() !== 'काही नाही' ? 1 : 0); return a; }, { appr: 0, past_amt: 0, past_cnt: 0, help: 0 });
                row += `<td>${fx.appr}</td><td>${formatCurrency(fx.past_amt)} / ${fx.past_cnt}</td><td>${fx.help}</td>`; break;
            case 'BM':
                const bm = staffReports.reduce((a, r) => { a.disb_amt += parseFloat(r.bm_disburse_amt || 0); a.disb_mem += parseInt(r.bm_disburse_members || 0); a.coll += parseFloat(r.bm_coll_total || 0); a.inv += parseFloat(r.bm_investment_amt || 0); a.appr_appr += parseInt(r.bm_appraisal_approved || 0); a.appr_rej += parseInt(r.bm_appraisal_rejected || 0); return a; }, { disb_amt: 0, disb_mem: 0, coll: 0, inv: 0, appr_appr: 0, appr_rej: 0 });
                row += `<td>${formatCurrency(bm.disb_amt)} / ${bm.disb_mem}</td><td>${formatCurrency(bm.coll)}</td><td>${bm.appr_appr} / ${bm.appr_rej}</td><td>${formatCurrency(bm.inv)}</td>`; break;
            case 'TA':
                const ta = staffReports.reduce((a, r) => { 
                    const analysisCount = parseInt(r.ta_analysis_reports);
                    a.analysis += isNaN(analysisCount) ? 0 : analysisCount;
                    a.yes += ((r.ta_coll_match || '').trim().toLowerCase() === 'होय' ? 1 : 0); 
                    a.no += ((r.ta_coll_match || '').trim().toLowerCase() === 'नाही' ? 1 : 0); 
                    a.updates += (((r.ta_finance_update || '').trim().toLowerCase() === 'होय' ? 1 : 0) + ((r.ta_spmb_update || '').trim().toLowerCase() === 'होय' ? 1 : 0)); 
                    a.rec_track += ((r.ta_recovery_tracker || '').trim().toLowerCase() === 'होय' ? 1 : 0); 
                    return a; 
                }, { yes: 0, no: 0, analysis: 0, updates: 0, rec_track: 0 });
                row += `<td>${ta.analysis}</td><td>${ta.yes} / ${ta.no}</td><td>${ta.updates}</td><td>${ta.rec_track}</td>`; break;
        }
        tableHTML += row + `</tr>`;
    });
    outputDiv.innerHTML = tableHTML + '</tbody></table>';
}

function generateIndividualAnalysis() {
    const staffName = document.getElementById('staffNameFilter').value;
    const outputDiv = document.getElementById('individual-analysis-result');
    if (!staffName) { outputDiv.innerHTML = `<p style="text-align:center; padding:20px; color:orange;">कृपया विश्लेषण करण्यासाठी एका कर्मचाऱ्याचे नाव निवडा.</p>`; return; }
    
    const { start, end } = getValidatedDates('startDate', 'endDate');
    if (!start || !end) return;
    
    const staffInfo = appState.allStaff.find(s => s[0] === staffName);
    const role = staffInfo ? staffInfo[2] : 'N/A';
    const totalDays = getTotalDaysInRange(start, end);
    const staffReports = appState.allReports.filter(r => { const d = parseSheetDate(r.date); return r.name === staffName && (r.leave || '').trim().toLowerCase() !== 'होय' && d && d >= start && d <= end; });
    const submissionRate = totalDays > 0 ? (staffReports.length / totalDays) * 100 : 0;
    
    let metrics = { totalReports: staffReports.length, submissionRate: submissionRate };
    let kpiHTML = '';
    
    const icon_submit = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>`;
    const icon_money = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM15 12c0 1.66-1.34 3-3 3s-3-1.34-3-3 1.34-3 3-3 3 1.34 3 3z"/></svg>`;
    const icon_people = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>`;
    const icon_check = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;
    const icon_doc = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>`;
    const icon_send = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>`;

    kpiHTML += createKpiCard('रिपोर्टिंग प्रमाण', `${submissionRate.toFixed(0)}% <span style="font-size:14px;font-weight:400;color:#566573;">(${staffReports.length}/${totalDays} days)</span>`, icon_submit, getPerformanceColor(submissionRate, true));

    switch(role) {
        case 'CA': const ca = staffReports.reduce((a,r) => { a.coll += parseFloat(r.ca_reg_amt || 0) + parseFloat(r.ca_odpast_amt || 0); a.meets += parseInt(r.ca_meeting_count || 0); a.mems += parseInt(r.ca_member_selection || 0); a.forms += parseInt(r.ca_forms_filled || 0); return a; }, {coll:0, meets:0, mems:0, forms:0}); metrics = {...metrics, ...ca}; kpiHTML += createKpiCard('एकूण कलेक्शन', formatCurrency(ca.coll), icon_money); kpiHTML += createKpiCard('एकूण बैठका', ca.meets, icon_people); kpiHTML += createKpiCard('नवीन सदस्य', ca.mems, icon_people); kpiHTML += createKpiCard('भरलेले फॉर्म', ca.forms, icon_doc); break;
        case 'FX': const fx = staffReports.reduce((a,r) => { a.appr += parseInt(r.fx_appraisal_count || 0); a.past_amt += parseFloat(r.fx_pastdue_amt || 0); a.past_cnt += parseInt(r.fx_pastdue_count || 0); a.help += ((r.fx_recovery_help || '').trim() && r.fx_recovery_help.toLowerCase() !== 'काही नाही' ? 1 : 0); return a; }, {appr:0, past_amt:0, past_cnt:0, help:0}); metrics = {...metrics, ...fx}; kpiHTML += createKpiCard('एकूण अॅप्रोयझल', fx.appr, icon_check); kpiHTML += createKpiCard('पास्ट डयु कलेक्शन', `${formatCurrency(fx.past_amt)} (${fx.past_cnt} खाती)`, icon_money); kpiHTML += createKpiCard('रिकव्हरी मदत', `${fx.help} वेळा`, icon_people); break;
        case 'BM': const bm = staffReports.reduce((a,r) => { a.disb_amt += parseFloat(r.bm_disburse_amt || 0); a.disb_mem += parseInt(r.bm_disburse_members || 0); a.coll += parseFloat(r.bm_coll_total || 0); a.inv += parseFloat(r.bm_investment_amt || 0); a.appr_appr += parseInt(r.bm_appraisal_approved || 0); a.appr_rej += parseInt(r.bm_appraisal_rejected || 0); return a; }, {disb_amt:0, disb_mem:0, coll:0, inv:0, appr_appr:0, appr_rej:0}); metrics = {...metrics, ...bm}; kpiHTML += createKpiCard('एकूण वाटप', `${formatCurrency(bm.disb_amt)} (${bm.disb_mem} सदस्य)`, icon_money); kpiHTML += createKpiCard('एकूण कलेक्शन', formatCurrency(bm.coll), icon_money); kpiHTML += createKpiCard('अॅप्रायझल स्टेटस', `${bm.appr_appr} मंजूर / ${bm.appr_rej} रद्द`, icon_check); kpiHTML += createKpiCard('गुंतवणूक', formatCurrency(bm.inv), icon_money); break;
        case 'TA': 
            const ta = staffReports.reduce((a,r) => { 
                const analysisCount = parseInt(r.ta_analysis_reports);
                a.analysis += isNaN(analysisCount) ? 0 : analysisCount;
                a.yes += ((r.ta_coll_match || '').trim().toLowerCase() === 'होय' ? 1 : 0); 
                a.no += ((r.ta_coll_match || '').trim().toLowerCase() === 'नाही' ? 1 : 0); 
                a.rec_track += ((r.ta_recovery_tracker || '').trim().toLowerCase() === 'होय' ? 1 : 0); 
                return a; 
            }, {yes:0, no:0, analysis:0, rec_track:0}); 
            metrics = {...metrics, ...ta}; 
            kpiHTML += createKpiCard('अॅनालिसिस रिपोर्ट्स', ta.analysis, icon_doc); 
            kpiHTML += createKpiCard('कलेक्शन मॅच (होय)', `${ta.yes} दिवस`, icon_check, 'var(--positive-color)'); 
            kpiHTML += createKpiCard('कलेक्शन मॅच (नाही)', `${ta.no} दिवस`, icon_check, ta.no > 0 ? 'var(--negative-color)' : 'var(--positive-color)'); 
            kpiHTML += createKpiCard('रिकव्हरी ट्रॅकर', `${ta.rec_track} वेळा पाठवले`, icon_send); 
            break;
    }
    
    const opinionHTML = `<div class="opinion-card"><h4><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>स्वयंचलित मत</h4><p>${createPerformanceSummary(role, metrics)}</p></div>`;
    outputDiv.innerHTML = `<h4>${staffName} - ${role}</h4><div class="kpi-card-grid">${kpiHTML}</div>${opinionHTML}`;
}

function generateCalendar() {
    const staffName = document.getElementById('staffNameCalendarFilter').value;
    const container = document.getElementById('calendar-container');
    if (!staffName) { container.innerHTML = `<p style="text-align:center; padding:20px; color:orange;">कृपया कॅलेंडर पाहण्यासाठी एका कर्मचाऱ्याचे नाव निवडा.</p>`; return; }

    const { start, end } = getValidatedDates('calendarStartDate', 'calendarEndDate');
    if (!start || !end) return;

    const staffReportsAll = appState.allReports.filter(r => { const d = parseSheetDate(r.date); return r.name === staffName && d && d >= start && d <= end; });
    const reportedDates = new Set(staffReportsAll.filter(r => (r.leave || '').trim().toLowerCase() !== 'होय').map(r => r.date));
    const leaveDates = new Set(staffReportsAll.filter(r => (r.leave || '').trim().toLowerCase() === 'होय').map(r => r.date));
    
    let calendarHTML = `<div class="calendar-grid">`;
    const daysOfWeek = ['रवि', 'सोम', 'मंगळ', 'बुध', 'गुरु', 'शुक्र', 'शनि'];
    daysOfWeek.forEach(day => { calendarHTML += `<div class="calendar-day day-header">${day}</div>`; });
    
    let currentDate = new Date(start);
    const startDayOfWeek = currentDate.getDay();
    for (let i = 0; i < startDayOfWeek; i++) { calendarHTML += `<div class="calendar-day empty"></div>`; }

    while (currentDate <= end) {
        const dateString = `${String(currentDate.getDate()).padStart(2, '0')}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/${currentDate.getFullYear()}`;
        if (leaveDates.has(dateString)) { calendarHTML += `<div class="calendar-day leave">${currentDate.getDate()}</div>`; } 
        else if (reportedDates.has(dateString)) { calendarHTML += `<div class="calendar-day reported" data-date="${dateString}">${currentDate.getDate()}</div>`; } 
        else { calendarHTML += `<div class="calendar-day missed">${currentDate.getDate()}</div>`; }
        currentDate.setDate(currentDate.getDate() + 1);
    }
    calendarHTML += `</div>`;

    const legendHTML = `<div class="calendar-legend"><span class="legend-item"><span class="legend-color reported"></span>अहवाल सादर</span><span class="legend-item"><span class="legend-color leave"></span>रजेवर</span><span class="legend-item"><span class="legend-color missed"></span>अहवाल नाही</span></div>`;
    container.innerHTML = legendHTML + calendarHTML;

    container.querySelectorAll('.reported').forEach(day => { day.addEventListener('click', () => showReportDetails(staffName, day.dataset.date)); });
}

function showReportDetails(staffName, date) {
    const report = appState.allReports.find(r => r.name === staffName && r.date === date && (r.leave || '').trim().toLowerCase() !== 'होय');
    if (!report) return;

    const modalBody = document.getElementById('modal-body');
    let detailsHTML = `<h4>${staffName} - ${date} रोजीचा अहवाल</h4><ul class="report-details-list">`;
    report.fullData.forEach((value, index) => {
        if (value && String(value).trim() !== "" && index < reportHeaders.length) {
            const header = reportHeaders[index];
            detailsHTML += `<li><strong>${header}:</strong> <span>${value}</span></li>`;
        }
    });
    detailsHTML += '</ul>';
    modalBody.innerHTML = detailsHTML;
    document.getElementById('reportModal').style.display = 'flex';
}

function closeModal() { document.getElementById('reportModal').style.display = 'none'; }
function createKpiCard(title, value, iconSvg, color = 'var(--primary-color)') { return `<div class="kpi-card"><div class="icon" style="background-color: ${color.replace(')', ', 0.1)')}; color: ${color};">${iconSvg}</div><div><div class="value">${value}</div><div class="title">${title}</div></div></div>`; }
function getValidatedDates(startId, endId) { const s=document.getElementById(startId).value, e=document.getElementById(endId).value; if(!s||!e){alert("कृपया 'पासून' आणि 'पर्यंत' दोन्ही तारखा निवडा.");return{}} const st=new Date(s), en=new Date(e); st.setHours(0,0,0,0); en.setHours(23,59,59,999); if(st>en){alert("सुरुवातची तारीख शेवटच्या तारखेपेक्षा जास्त असू शकत नाही.");return{}} return{start:st,end:en}; }
function parseSheetDate(d) { if (!d) return null; const p = d.split('/'); if (p.length !== 3) return null; return new Date(p[2], p[1] - 1, p[0]); }
function formatCurrency(n) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n || 0); }
function getTotalDaysInRange(s, e) { let c = 0; const d = new Date(s.getTime()); while (d <= e) { c++; d.setDate(d.getDate() + 1); } return c; }
function getPerformanceColor(r, i=false) { if(r>=90)return i?'var(--positive-color)':'#27ae60'; if(r>=70)return i?'var(--neutral-color)':'#f39c12'; return i?'var(--negative-color)':'#e74c3c'; }
function createPerformanceSummary(role, m) { if (m.totalReports === 0) return "निवडलेल्या कालावधीत या कर्मचाऱ्याने कोणताही कामाचा अहवाल दाखल केलेला नाही."; let s = []; if(m.submissionRate>=90)s.push("अहवाल दाखल करण्यात अत्यंत नियमित आहेत."); else if(m.submissionRate>=70)s.push("अहवाल दाखल करण्यात नियमित आहेत."); else s.push("अहवाल दाखल करण्यात अनियमितता दिसून येते."); switch(role) { case 'CA': if(m.coll>0)s.push(`त्यांचे एकूण कलेक्शन ${formatCurrency(m.coll)} समाधानकारक दिसते.`); if(m.forms > 0) s.push(`${m.forms} फॉर्म्स यशस्वीरित्या भरले आहेत.`); break; case 'FX': if(m.appr>0)s.push(`त्यांनी ${m.appr} गटांचे अॅप्रोयझल पूर्ण केले आहे.`); if(m.help > 0) s.push("ते रिकव्हरीमध्ये सक्रियपणे मदत करत आहेत."); break; case 'BM': if(m.disb_amt>0)s.push(`त्यांनी ${formatCurrency(m.disb_amt)} रकमेचे यशस्वीरित्या वाटप केले आहे.`); if(m.appr_appr > 0) s.push(`${m.appr_appr} अॅप्रायझल मंजूर केले आहेत.`); if(m.inv > 0) s.push("गुंतवणूक मिळवण्यातही त्यांचे योगदान आहे."); break; case 'TA': const totalMatches = m.yes + m.no; const mismatch = totalMatches > 0 ? (m.no / totalMatches) * 100 : 0; if (mismatch === 0 && totalMatches > 0) s.push("त्यांच्या कामात अचूकता आहे."); else if (mismatch > 0) s.push("कलेक्शन मॅच न होण्यावर लक्ष देण्याची गरज आहे."); if(m.rec_track > 0) s.push("ते नियमितपणे रिकव्हरी ट्रॅकर पाठवत आहेत."); break; } if(m.submissionRate > 80 && s.length > 1) s.push("एकूणच, त्यांची कामगिरी चांगली आणि सातत्यपूर्ण दिसते."); return s.join(' '); }
</script>
</body>
</html>