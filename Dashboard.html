<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>दैनिक अहवाल डॅशबोर्ड</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-bg: #f0f2f5; --card-bg: #ffffff; --header-bg-start: #1B4F72; --header-bg-end: #5DADE2; --primary-text: #34495E; --secondary-text: #7F8C8D; --accent-color: #5DADE2; --submitted-color: #2ECC71; --pending-color: #F39C12; --border-color: #e5e7eb; --shadow-light: rgba(0,0,0,0.05); --shadow-medium: rgba(0,0,0,0.1);
        --role-ca-color: #3498DB; --role-fx-color: #9B59B6; --role-bm-color: #E74C3C; --role-ta-color: #16A085;
        --consent-color: #1ABC9C; --performance-color: #8E44AD;
    }
    body { font-family: 'Inter', 'Noto Sans Devanagari', sans-serif; background: var(--primary-bg); margin: 0; padding: 0; color: var(--primary-text); }
    header { background: linear-gradient(90deg, var(--header-bg-start), var(--header-bg-end)); padding: 20px 30px; color: white; text-align: center; font-size: 26px; font-weight: 700; letter-spacing: 1px; box-shadow: 0 4px 12px var(--shadow-medium); position: sticky; top: 0; z-index: 100; }
    .main-container { padding: 15px; }
    .filters-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; }
    .filter-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
    .filter-controls label { font-weight: 600; }
    .filter-controls input[type="date"], .search-controls input[type="date"], .search-controls input[type="text"] { border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 6px; font-family: 'Inter', 'Noto Sans Devanagari', sans-serif; font-size: 14px; }
    .filter-controls button, .search-controls button { background-color: var(--header-bg-start); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; }
    .filter-controls button:hover, .search-controls button:hover { background-color: var(--accent-color); }
    .branch-tabs { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; border-top: 1px solid var(--border-color); padding-top: 20px; }
    .branch-tab { padding: 8px 18px; border-radius: 20px; background: #e9ecef; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; border: 1px solid transparent; }
    .branch-tab.active { background: var(--accent-color); color: white; box-shadow: 0 2px 8px rgba(93, 173, 226, 0.4); border-color: var(--header-bg-start); }
    .kpi-container, .role-kpi-grid { display: grid; gap: 20px; }
    .kpi-container { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .role-kpi-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); }
    .kpi { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-light); display: flex; align-items: center; gap: 15px; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; border-left: 5px solid; }
    .kpi:hover { transform: translateY(-5px); box-shadow: 0 6px 20px var(--shadow-medium); }
    .kpi-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0;}
    .kpi-icon svg { width: 24px; height: 24px; }
    .kpi-content .kpi-value { font-size: 32px; font-weight: 700; color: var(--primary-text); }
    .kpi-content .kpi-label { font-size: 14px; font-weight: 500; color: var(--secondary-text); }
    #totalStaff { border-color: var(--primary-text); } #totalStaff .kpi-icon { background-color: #e8f0fe; }
    #submittedReports { border-color: var(--submitted-color); } #submittedReports .kpi-icon { background-color: #e6f9f0; }
    #pendingReports { border-color: var(--pending-color); } #pendingReports .kpi-icon { background-color: #fff8e1; }
    #consentForms { border-color: var(--consent-color); } #consentForms .kpi-icon { background-color: rgba(26, 188, 156, 0.1); }
    #reportingPerformance { border-color: var(--performance-color); } #reportingPerformance .kpi-icon { background-color: rgba(142, 68, 173, 0.1); }
    .role-kpi { border-left-width: 5px; } .role-kpi .kpi-value { font-size: 26px; }
    #kpiCA { border-color: var(--role-ca-color); } #kpiCA .kpi-icon { background-color: rgba(52, 152, 219, 0.1); }
    #kpiFX { border-color: var(--role-fx-color); } #kpiFX .kpi-icon { background-color: rgba(155, 89, 182, 0.1); }
    #kpiBM { border-color: var(--role-bm-color); } #kpiBM .kpi-icon { background-color: rgba(231, 76, 60, 0.1); }
    #kpiTA { border-color: var(--role-ta-color); } #kpiTA .kpi-icon { background-color: rgba(22, 160, 133, 0.1); }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    .left-column, .right-column { display: flex; flex-direction: column; gap: 20px; }
    .insights { border-left: 5px solid var(--accent-color); }
    .card h3 { margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;}
    .insights ul { padding-left: 20px; margin: 0; } .insights li { margin-bottom: 10px; line-height: 1.6; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--border-color); }
    th { background: #fafafa; font-weight: 600; text-transform: uppercase; color: var(--secondary-text); }
    tbody tr:hover { background-color: #f8f9fa; }
    .clickable { color: #1B4F72 !important; cursor: pointer; text-decoration: none; font-weight: bold !important; }
    .clickable:hover { text-decoration: underline; color: #5DADE2 !important; }
    .list-card.highlight { box-shadow: 0 0 0 3px var(--accent-color), 0 4px 15px var(--shadow-light); }
    .history-card .search-controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 20px; }
    .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
    .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); animation: fadeIn 0.3s; max-height: 85vh; overflow-y: auto;}
    @keyframes fadeIn { from {opacity: 0; transform: translateY(-20px);} to {opacity: 1; transform: translateY(0);} }
    .close { float: right; font-size: 28px; cursor: pointer; color: #aaa; font-weight: bold; line-height: 1;}
    #modalReportContent p { margin: 10px 0; line-height: 1.6; }
    #modalReportContent strong { color: var(--primary-text); min-width: 180px; display: inline-block; }
    .role-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .role-list-container h4 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; font-size: 16px; }
    .role-list-container ul { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
    .role-list-container li { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
    .progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .progress-bar { height: 18px; line-height: 18px; text-align: right; padding-right: 5px; color: white; font-size: 12px; font-weight: bold; border-radius: 4px; background-color: var(--submitted-color); transition: width 0.5s ease-in-out; }
    .progress-bar.medium { background-color: var(--pending-color); }
    .progress-bar.low { background-color: var(--role-bm-color); }
    @media (max-width: 600px) { .role-details-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<header>दैनिक अहवाल डॅशबोर्ड</header>
<div class="main-container">
    <div class="filters-card">
        <div class="filter-controls">
            <label>दिनांक:</label>
            <input type="date" id="dashboardDate">
            <button onclick="loadDashboard()">डेटा रिफ्रेश करा</button>
        </div>
        <div class="branch-tabs"></div>
    </div>
    <div class="kpi-container">
        <div class="kpi" id="totalStaff"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="var(--primary-text)" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiTotal">0</div><div class="kpi-label">एकूण कर्मचारी</div></div></div>
        <div class="kpi" id="submittedReports" onclick="highlightList('submitted')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="var(--submitted-color)" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiSubmitted">0</div><div class="kpi-label">सबमिट अहवाल</div></div></div>
        <div class="kpi" id="pendingReports" onclick="highlightList('pending')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="var(--pending-color)" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiPending">0</div><div class="kpi-label">प्रलंबित अहवाल</div></div></div>
        <div class="kpi" id="consentForms" onclick="showConsentDetails()"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--consent-color)"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 14h-2v2h-2v-2H8v-2h4V8h2v6h2v2zm-3-7V3.5L18.5 9H13z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiValueConsent">0</div><div class="kpi-label">संमती फॉर्म</div></div></div>
        <div class="kpi" id="reportingPerformance" onclick="showPerformanceDetails()"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--performance-color)"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiValuePerformance">0%</div><div class="kpi-label">सरासरी रिपोर्टिंग</div></div></div>
    </div>
    <div class="card" style="margin-top: 20px;">
        <h3>भूमिका-निहाय कामगिरी (Role-wise Performance)</h3>
        <div class="role-kpi-grid">
            <div class="kpi role-kpi" id="kpiCA" onclick="showRoleDetails('CA')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--role-ca-color)"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm0-4H7V5h10v8z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiValueCA">0 / 0</div><div class="kpi-label" id="kpiLabelCA">CA (क्रेडिट)</div></div></div>
            <div class="kpi role-kpi" id="kpiFX" onclick="showRoleDetails('FX')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--role-fx-color)"><path d="M15 17h2v-3h1v-2h-1v-1h2v-3h-2V7h-2v1h-1V7h-2v1h-1V7H9v1H8v3h2v1H8v2h1v3H7v-1h1v-2H7v-1H5v2h1v3h2v-1h1v1h2v-1h1v1h2zm-4-4h2v-1h-2v1z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiValueFX">0 / 0</div><div class="kpi-label" id="kpiLabelFX">FX (Field Excutive)</div></div></div>
            <div class="kpi role-kpi" id="kpiBM" onclick="showRoleDetails('BM')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--role-bm-color)"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zM10 4h4v2h-4V4zm10 15H4V8h16v11z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiValueBM">0 / 0</div><div class="kpi-label" id="kpiLabelBM">BM (शाखा व्यवस्थापक)</div></div></div>
            <div class="kpi role-kpi" id="kpiTA" onclick="showRoleDetails('TA')"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="var(--role-ta-color)"><path d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l2.6 1.53c.56-1.24.88-2.62.88-4.07 0-5.18-3.95-9.45-9-9.95zM12 19c-3.87 0-7-3.13-7-7 0-3.53 2.61-6.43 6-6.92V2.05c-5.06.5-9 4.76-9 9.95 0 5.52 4.48 10 10 10s10-4.48 10-10c0-1.18-.21-2.31-.6-3.36l-2.67 1.54c.43.9.7 1.94.7 3.02 0 3.87-3.13 7-7 7z"/></svg></div><div class="kpi-content"><div class="kpi-value" id="kpiValueTA">0 / 0</div><div class="kpi-label" id="kpiLabelTA">TA (Unit Accountant)</div></div></div>
        </div>
    </div>
    <div class="dashboard-grid" style="margin-top: 20px;">
        <div class="left-column">
            <div class="card chart-card"><div id="piechart" style="width: 100%; height: 350px;"></div></div>
            <div class="card insights"><h3>📈 मुख्य सूचना (Insights)</h3><ul id="branchInsights"><li>डेटा लोड होत आहे...</li></ul></div>
        </div>
        <div class="right-column">
            <div class="card list-card" id="submittedCard"><h3>✅ सबमिट अहवाल यादी</h3><table id="submittedList"><thead><tr><th>कर्मचारी</th><th>अहवाल वाचा</th></tr></thead><tbody></tbody></table></div>
            <div class="card list-card" id="pendingCard"><h3>❌ प्रलंबित अहवाल यादी</h3><table id="pendingList"><thead><tr><th>कर्मचारी</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>
    <div class="card history-card" style="margin-top: 20px;">
        <h3><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="var(--primary-text)"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> कर्मचारी अहवाल शोधा</h3>
        <div class="search-controls">
            <input type="text" id="searchName" placeholder="कर्मचारी नाव लिहा..." onkeyup="handleSearchKey(event)">
            <label>पासून:</label> <input type="date" id="startDate">
            <label>पर्यंत:</label> <input type="date" id="endDate">
            <button onclick="searchHistory()">शोधा</button>
        </div>
        <table id="historyTable"><thead><tr><th>दिनांक</th><th>कर्मचारी</th><th>अहवाल</th></tr></thead><tbody></tbody></table>
    </div>
</div>
<div id="reportModal" class="modal"><div class="modal-content"><span class="close" onclick="document.getElementById('reportModal').style.display='none'">&times;</span><h3>अहवाल तपशील</h3><div id="modalReportContent"></div></div></div>
<div id="roleDetailsModal" class="modal"><div class="modal-content" style="max-width: 700px;"><span class="close" onclick="document.getElementById('roleDetailsModal').style.display='none'">&times;</span><h3 id="roleModalTitle">भूमिका तपशील</h3><div class="role-details-grid"><div class="role-list-container"><h4>✅ सबमिट केलेले</h4><ul id="roleSubmittedList"></ul></div><div class="role-list-container"><h4>❌ प्रलंबित</h4><ul id="rolePendingList"></ul></div></div></div></div>

<div id="consentModal" class="modal"><div class="modal-content"><span class="close" onclick="document.getElementById('consentModal').style.display='none'">&times;</span><h3>संमती फॉर्म अहवाल</h3><div id="consentModalContent"></div></div></div>
<div id="performanceModal" class="modal"><div class="modal-content" style="max-width: 800px;"><span class="close" onclick="document.getElementById('performanceModal').style.display='none'">&times;</span><h3 id="performanceModalTitle">मासिक रिपोर्टिंग कामगिरी</h3><div id="performanceModalContent"></div></div></div>


<script>
// --- CONFIGURATION ---
const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
const SHEET_ID = "1or7yTCZLhu1qdTijEBC--9lHsigVb3yy1nY-qByHIGY";
const STAFF_SHEET = "StaffList";
const REPORTS_SHEET = "Reports";
const ROLES = ['CA', 'FX', 'BM', 'TA'];

google.charts.load('current', {'packages':['corechart']});

const appState = { allStaff: [], allReports: [], currentBranch: "ALL", dataLoaded: false, viewableReports: [], monthlyPerformance: [] };
document.getElementById('dashboardDate').valueAsDate = new Date();

function changeBranch(branch, element) {
    appState.currentBranch = branch;
    document.querySelectorAll('.branch-tab').forEach(tab => tab.classList.remove('active'));
    element.classList.add('active');
    processData();
}
function highlightList(type) {
    const card = document.getElementById(type === 'submitted' ? 'submittedCard' : 'pendingCard');
    document.querySelectorAll('.list-card').forEach(c => c.classList.remove('highlight'));
    if (card) { card.classList.add('highlight'); card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
}
function handleSearchKey(event) { if (event.key === 'Enter') searchHistory(); }

async function loadDashboard() {
    document.querySelector('header').innerText = 'डेटा लोड होत आहे...';
    try {
        const staffPromise = fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${STAFF_SHEET}?key=${API_KEY}`);
        const reportPromise = fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${REPORTS_SHEET}?key=${API_KEY}`);
        const [staffRes, reportRes] = await Promise.all([staffPromise, reportPromise]);
        if (!staffRes.ok) throw new Error(`Staff list API call failed: ${staffRes.status}`);
        if (!reportRes.ok) throw new Error(`Reports list API call failed: ${reportRes.status}`);
        const staffData = await staffRes.json();
        const reportData = await reportRes.json();
        appState.allStaff = staffData.values ? staffData.values.slice(1).filter(s => s[0] && s[0].trim() !== '') : [];
        appState.allReports = reportData.values ? reportData.values.slice(1).filter(r => r[1] && r[1].trim() !== '') : [];

        const branches = [...new Set(appState.allStaff.map(row => row[1]))].filter(Boolean).sort();
        const tabsContainer = document.querySelector('.branch-tabs');
        tabsContainer.innerHTML = '<div class="branch-tab active" onclick="changeBranch(\'ALL\', this)">सर्व शाखा</div>';
        branches.forEach(branch => {
            tabsContainer.innerHTML += `<div class="branch-tab" onclick="changeBranch('${branch.toUpperCase()}', this)">${branch}</div>`;
        });

        appState.dataLoaded = true;
        document.querySelector('header').innerText = 'दैनिक अहवाल डॅशबोर्ड';
        processData();
    } catch (error) {
        console.error("Error loading data:", error);
        alert(`डेटा लोड करण्यात अयशस्वी: ${error.message}`);
        document.querySelector('header').innerText = 'डेटा लोड करण्यात अयशस्वी';
    }
}

function getBusinessDays(startDate, endDate) {
    let count = 0;
    const curDate = new Date(startDate.getTime());
    while (curDate <= endDate) {
        const dayOfWeek = curDate.getDay();
        if (dayOfWeek !== 0) { // Exclude Sundays
            count++;
        }
        curDate.setDate(curDate.getDate() + 1);
    }
    return count > 0 ? count : 1; // Avoid division by zero
}

function processData() {
    if (!appState.dataLoaded) return;
    const date = new Date(document.getElementById('dashboardDate').value).toLocaleDateString('en-GB', { timeZone: 'Asia/Kolkata' });
    const filteredStaff = appState.currentBranch === "ALL" ? appState.allStaff : appState.allStaff.filter(s => s[1] && s[1].toUpperCase() === appState.currentBranch);
    const submittedReportRows = appState.allReports.filter(r => r[1] === date && (appState.currentBranch === "ALL" || (r[3] && r[3].toUpperCase() === appState.currentBranch)));
    
    appState.viewableReports = submittedReportRows.map(r => createReportObject(r));
    const submittedNames = new Set(appState.viewableReports.map(r => r.name));
    const pendingStaff = filteredStaff.filter(s => !submittedNames.has(s[0]));
    
    const metrics = { total: filteredStaff.length, submitted: appState.viewableReports.length, pending: pendingStaff.length };
    
    const roleMetrics = {};
    ROLES.forEach(role => roleMetrics[role] = { total: 0, submitted: 0 });

    filteredStaff.forEach(staff => {
        const role = staff[2]?.toUpperCase();
        if (role && ROLES.includes(role)) roleMetrics[role].total++;
    });

    appState.viewableReports.forEach(reportObject => {
        const role = reportObject.role?.toUpperCase();
        if (role && ROLES.includes(role)) { roleMetrics[role].submitted++; }
    });
    
    // Calculate and update Consent Form KPI
    const totalConsentForms = appState.viewableReports.reduce((sum, report) => sum + (parseInt(report.fx_auto_emi_filled) || 0), 0);
    document.getElementById('kpiValueConsent').innerText = totalConsentForms;

    // Calculate monthly performance
    calculateMonthlyPerformance(filteredStaff);

    updateKPIs(metrics);
    updateRoleKPIs(roleMetrics);
    drawPieChart(metrics.submitted, metrics.pending);
    populateLists(appState.viewableReports, pendingStaff);
    generateInsights(date);
}

function calculateMonthlyPerformance(filteredStaff) {
    const selectedDate = new Date(document.getElementById('dashboardDate').value);
    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();
    const startDateOfMonth = new Date(year, month, 1);
    const businessDaysSoFar = getBusinessDays(startDateOfMonth, selectedDate);
    
    const monthlyReports = appState.allReports.filter(r => {
        const dateParts = r[1].split('/'); // DD/MM/YYYY
        if (dateParts.length !== 3) return false;
        const reportDate = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
        return reportDate >= startDateOfMonth && reportDate <= selectedDate;
    });
    
    const submissionCounts = {};
    monthlyReports.forEach(r => {
        const staffName = r[2];
        if(staffName) submissionCounts[staffName] = (submissionCounts[staffName] || 0) + 1;
    });

    appState.monthlyPerformance = filteredStaff.map(staff => {
        const name = staff[0];
        const branch = staff[1];
        const submissions = submissionCounts[name] || 0;
        const percentage = Math.min(100, (submissions / businessDaysSoFar) * 100);
        return { name, branch, submissions, totalDays: businessDaysSoFar, percentage };
    });

    const totalPercentage = appState.monthlyPerformance.reduce((sum, p) => sum + p.percentage, 0);
    const avgPercentage = filteredStaff.length > 0 ? (totalPercentage / filteredStaff.length) : 0;
    
    document.getElementById('kpiValuePerformance').innerText = `${avgPercentage.toFixed(0)}%`;
}


function updateKPIs(metrics) {
    document.getElementById('kpiTotal').innerText = metrics.total;
    document.getElementById('kpiSubmitted').innerText = metrics.submitted;
    document.getElementById('kpiPending').innerText = metrics.pending;
}
function updateRoleKPIs(roleMetrics) {
    ROLES.forEach(role => {
        const valueEl = document.getElementById(`kpiValue${role}`);
        const data = roleMetrics[role];
        if (valueEl && data) { valueEl.innerText = `${data.submitted} / ${data.total}`; }
    });
}
function populateLists(submittedReportObjects, pendingStaff) {
    const submittedTableBody = document.querySelector('#submittedList tbody');
    submittedTableBody.innerHTML = submittedReportObjects.length === 0 ? `<tr><td colspan="2" style="text-align:center; color:#777;">आज कोणीही अहवाल सबमिट केलेला नाही.</td></tr>` : submittedReportObjects.map((report, index) => `<tr><td>${report.name}</td><td><span class="clickable" onclick="viewReport(${index})">वाचा</span></td></tr>`).join('');
    const pendingTableBody = document.querySelector('#pendingList tbody');
    pendingTableBody.innerHTML = pendingStaff.length === 0 ? `<tr><td style="text-align:center; color:#777;">कोणीही प्रलंबित नाही.</td></tr>` : pendingStaff.map(staff => `<tr><td>${staff[0]}</td></tr>`).join('');
}
function generateInsights(date) {
    const insightsList = document.getElementById('branchInsights');
    insightsList.innerHTML = '';
    const reportsOnDate = appState.allReports.filter(r => r[1] === date);
    if (appState.currentBranch === "ALL") {
        const totalSubmitted = reportsOnDate.length;
        const totalStaff = appState.allStaff.length;
        const overallRate = totalStaff > 0 ? (totalSubmitted / totalStaff) * 100 : 0;
        insightsList.innerHTML += `<li><strong>एकूण सबमिशन दर:</strong> ${overallRate.toFixed(1)}% (${totalSubmitted}/${totalStaff})</li>`;
    } else {
        const staffInBranch = appState.allStaff.filter(s => s[1] && s[1].toUpperCase() === appState.currentBranch);
        const submittedInBranch = reportsOnDate.filter(r => r[3] && r[3].toUpperCase() === appState.currentBranch);
        const branchRate = staffInBranch.length > 0 ? (submittedInBranch.length / staffInBranch.length) * 100 : 0;
        insightsList.innerHTML += `<li><strong>${appState.currentBranch} सबमिशन दर:</strong> ${branchRate.toFixed(1)}% (${submittedInBranch.length}/${staffInBranch.length})</li>`;
    }
}
function drawPieChart(submitted, pending) {
    google.charts.setOnLoadCallback(() => {
        const data = google.visualization.arrayToDataTable([['स्थिती', 'संख्या'], ['सबमिट', submitted], ['प्रलंबित', pending]]);
        const options = { title: 'आजची अहवाल स्थिती', pieHole: 0.5, colors: ['#2ECC71', '#F39C12'], pieSliceTextStyle: { color: '#ffffff', fontSize: 14, fontWeight: 'bold' }, chartArea: { width: '95%', height: '80%' }, legend: { position: 'bottom' }, fontName: 'Inter', titleTextStyle: { fontSize: 18, fontWeight: 'bold' }};
        const chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);
    });
}

function createReportObject(row) {
    return {
        date: row[1], name: row[2], branch: row[3], leave: row[4], role: row[5],
        ca_reg_count: row[6], ca_reg_amt: row[7], ca_odpast_count: row[8], ca_odpast_amt: row[9],
        ca_meeting_village: row[10], ca_meeting_count: row[11], ca_member_selection: row[12], ca_forms_filled: row[13],
        fx_appraisal_count: row[14], fx_appraisal_villages: row[15], fx_recovery_help: row[16],
        fx_pastdue_count: row[17], fx_pastdue_amt: row[18], fx_auto_emi_filled: row[19],
        bm_disburse_village: row[20], bm_disburse_members: row[21], bm_disburse_amt: row[22],
        bm_coll_regular: row[23], bm_coll_pastdue: row[24], bm_coll_od: row[25], bm_coll_total: row[26],
        bm_appr_approved: row[27], bm_appr_rejected: row[28], bm_reject_reason: row[29], bm_investment_amt: row[30],
        ta_analysis_reports: row[31], ta_coll_match: row[32], ta_match_reason: row[33],
        ta_finance_update: row[34], ta_spmb_update: row[35], ta_recovery_tracker: row[36], ta_auto_emi_activated: row[37],
        notes: row[38]
    };
}

function findReportIndexByName(name) {
    return appState.viewableReports.findIndex(report => report.name === name);
}

function showRoleDetails(role) {
    const staffInRole = appState.allStaff.filter(staff => (appState.currentBranch === "ALL" || staff[1]?.toUpperCase() === appState.currentBranch) && staff[2]?.toUpperCase() === role);
    const reportsForThisRole = appState.viewableReports.filter(obj => obj.role === role);
    const submittedNamesInRole = new Set(reportsForThisRole.map(r => r.name));
    const pendingList = staffInRole.filter(s => !submittedNamesInRole.has(s[0]));
    const modal = document.getElementById('roleDetailsModal');
    document.getElementById('roleModalTitle').innerText = `${document.getElementById(`kpiLabel${role}`).innerText} - अहवाल स्थिती (${appState.currentBranch === 'ALL' ? 'सर्व शाखा' : appState.currentBranch})`;
    document.getElementById('roleSubmittedList').innerHTML = reportsForThisRole.length > 0 
        ? reportsForThisRole.map(s => { const originalIndex = findReportIndexByName(s.name); return `<li><span>${s.name}</span><span class="clickable" onclick="viewReport(${originalIndex})">वाचा</span></li>` }).join('') 
        : `<li style="color:#777;">कोणीही अहवाल सबमिट केलेला नाही.</li>`;
    document.getElementById('rolePendingList').innerHTML = pendingList.length > 0 ? pendingList.map(p => `<li>${p[0]}</li>`).join('') : `<li style="color:var(--submitted-color);">सर्व अहवाल सबमिट झाले आहेत.</li>`;
    modal.style.display = 'block';
}

function viewReport(reportIndex) {
    if (reportIndex < 0 || reportIndex >= appState.viewableReports.length) { console.error("Invalid report index:", reportIndex); return; }
    const data = appState.viewableReports[reportIndex];
    const modalContent = document.getElementById('modalReportContent');
    let html = `<p><strong>कर्मचारी:</strong> ${data.name || 'N/A'}</p><p><strong>शाखा:</strong> ${data.branch || 'N/A'}</p><hr>`;
    
    if (data.leave === 'होय') {
        html += `<p style="font-size: 1.2em; font-weight: bold; color: var(--pending-color);"><strong>स्थिती:</strong> रजा</p>`;
    } else {
        switch(data.role) {
            case 'CA':
                html = `<h4>CA - क्रेडिट असिस्टंट अहवाल</h4><p><strong>रेग्युलर कलेक्शन:</strong> ${data.ca_reg_count || 0} खाती, ${data.ca_reg_amt || 0} रु.</p><p><strong>ओडी/पास्टडयु कलेक्शन:</strong> ${data.ca_odpast_count || 0} खाती, ${data.ca_odpast_amt || 0} रु.</p><p><strong>गट बैठका:</strong> ${data.ca_meeting_count || 0} (${data.ca_meeting_village || 'गाव नाही'})</p><p><strong>सदस्य निवड:</strong> ${data.ca_member_selection || 0}</p><p><strong>गट फॉर्म भरले:</strong> ${data.ca_forms_filled || 0}</p><p><strong>विशेष नोंदी:</strong> ${data.notes || 'काही नाही'}</p>`;
                break;
            case 'FX':
                html = `<h4>FX - फील्ड एक्झिक्युटिव्ह अहवाल</h4><p><strong>अॅप्रोयझल:</strong> ${data.fx_appraisal_count || 0} गट (${data.fx_appraisal_villages || 'गाव नाही'})</p><p><strong>रिकवरी मध्ये मदत:</strong> ${data.fx_recovery_help || 'काही नाही'}</p><p><strong>पास्ट डयु कलेक्शन:</strong> ${data.fx_pastdue_count || 0} खाती, ${data.fx_pastdue_amt || 0} रु.</p><p><strong>ऑटो EMI फॉर्म भरले:</strong> ${data.fx_auto_emi_filled || 0}</p><p><strong>विशेष नोंदी:</strong> ${data.notes || 'काही नाही'}</p>`;
                break;
            case 'BM':
                 html = `<h4>BM - शाखा व्यवस्थापक अहवाल</h4><p><strong>लोन वाटप:</strong> ${data.bm_disburse_members || 0} मेंबर (${data.bm_disburse_village || 'गाव नाही'}), ${data.bm_disburse_amt || 0} रु.</p><p><strong>एकुण कलेक्शन:</strong> रेग्युलर: ${data.bm_coll_regular || 0} | पास्ट डयु: ${data.bm_coll_pastdue || 0} | ओडी: ${data.bm_coll_od || 0} | <strong>एकूण: ${data.bm_coll_total || 0} रु.</strong></p><p><strong>अॅप्रायझल स्टेटस:</strong> ${data.bm_appr_approved || 0} मंजुर, ${data.bm_appr_rejected || 0} रद्द</p><p><strong>रद्द करण्याची कारणे:</strong> ${data.bm_reject_reason || 'काही नाही'}</p><p><strong>गुंतवणूक:</strong> ${data.bm_investment_amt || 0} रु.</p><p><strong>विशेष नोंदी:</strong> ${data.notes || 'काही नाही'}</p>`;
                break;
            case 'TA':
                 html = `<h4>TA - युनिट अकाऊंटंट अहवाल</h4><p><strong>अॅनालिसीस रिर्पाट:</strong> ${data.ta_analysis_reports || 0}</p><p><strong>कलेक्शन मॅच:</strong> ${data.ta_coll_match || 'N/A'}</p><p><strong>मॅच न होण्याचे कारण:</strong> ${data.ta_match_reason || 'लागू नाही'}</p><p><strong>फायनान्स सिस्टीम अपडेट:</strong> ${data.ta_finance_update ? new Date(data.ta_finance_update).toLocaleDateString('mr-IN') : 'N/A'}</p><p><strong>SPMB टि सिस्टीम अपडेट:</strong> ${data.ta_spmb_update ? new Date(data.ta_spmb_update).toLocaleDateString('mr-IN') : 'N/A'}</p><p><strong>रिकव्हरी ट्रॅकर पाठवले:</strong> ${data.ta_recovery_tracker || 'N/A'}</p><p><strong>ऑटो EMI फॉर्म लागु केले:</strong> ${data.ta_auto_emi_activated || 0}</p><p><strong>विशेष नोंदी:</strong> ${data.notes || 'काही नाही'}</p>`;
                break;
            default:
                html = `<h4>${data.role || 'इतर'} अहवाल</h4><p><strong>नोंदी:</strong> ${data.notes || 'काही नाही'}</p>`;
        }
    }
    modalContent.innerHTML = html;
    document.getElementById('reportModal').style.display = 'block';
}

function showConsentDetails() {
    const modal = document.getElementById('consentModal');
    const content = document.getElementById('consentModalContent');
    const consentGivers = appState.viewableReports.filter(r => r.fx_auto_emi_filled && parseInt(r.fx_auto_emi_filled) > 0);
    if (consentGivers.length === 0) {
        content.innerHTML = `<p style="text-align:center; color:#777;">आज कोणतेही संमती फॉर्म सबमिट केलेले नाहीत.</p>`;
    } else {
        let tableHTML = '<table><thead><tr><th>कर्मचारी</th><th>फॉर्म संख्या</th></tr></thead><tbody>';
        consentGivers.forEach(r => { tableHTML += `<tr><td>${r.name}</td><td>${r.fx_auto_emi_filled}</td></tr>`; });
        tableHTML += '</tbody></table>';
        content.innerHTML = tableHTML;
    }
    modal.style.display = 'block';
}

function showPerformanceDetails() {
    const modal = document.getElementById('performanceModal');
    const content = document.getElementById('performanceModalContent');
    const title = document.getElementById('performanceModalTitle');
    const selectedDate = new Date(document.getElementById('dashboardDate').value);
    const monthName = selectedDate.toLocaleString('mr-IN', { month: 'long' });
    title.innerText = `${monthName} महिन्यासाठी रिपोर्टिंग कामगिरी (${appState.currentBranch === 'ALL' ? 'सर्व शाखा' : appState.currentBranch})`;

    if (!appState.monthlyPerformance || appState.monthlyPerformance.length === 0) {
        content.innerHTML = `<p style="text-align:center; color:#777;">कामगिरी डेटा उपलब्ध नाही.</p>`;
        modal.style.display = 'block';
        return;
    }
    const sortedPerformance = [...appState.monthlyPerformance].sort((a, b) => b.percentage - a.percentage);
    let tableHTML = `<p style="text-align:center; font-size:14px; color:var(--secondary-text);">
        ${selectedDate.toLocaleDateString('mr-IN')} पर्यंत ${sortedPerformance[0]?.totalDays || 0} कामकाजाच्या दिवसांवर आधारित.</p>
        <table><thead><tr><th>रँक</th><th>कर्मचारी</th><th>शाखा</th><th style="width: 40%;">कामगिरी (${sortedPerformance[0]?.totalDays || 0} दिवसांपैकी)</th></tr></thead><tbody>`;

    sortedPerformance.forEach((p, index) => {
        let barClass = 'progress-bar';
        if (p.percentage < 75) barClass += ' medium';
        if (p.percentage < 50) barClass += ' low';
        tableHTML += `<tr><td>${index + 1}</td><td>${p.name}</td><td>${p.branch}</td><td>
            <div class="progress-bar-container">
                <div class="${barClass}" style="width: ${p.percentage.toFixed(1)}%;">
                   ${p.submissions} (${p.percentage.toFixed(0)}%)</div></div></td></tr>`;
    });
    tableHTML += '</tbody></table>';
    content.innerHTML = tableHTML;
    modal.style.display = 'block';
}

function searchHistory() {
    const name = document.getElementById('searchName').value.trim().toLowerCase();
    const startInput = document.getElementById('startDate').value;
    const endInput = document.getElementById('endDate').value;
    if (!startInput || !endInput) { alert("कृपया 'पासून' आणि 'पर्यंत' दोन्ही तारखा निवडा."); return; }
    const start = new Date(startInput); start.setHours(0, 0, 0, 0);
    const end = new Date(endInput); end.setHours(23, 59, 59, 999);
    
    const results = appState.allReports.filter(r => {
        const dateParts = r[1].split('/');
        if (dateParts.length !== 3) return false;
        const reportDate = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
        const staffName = r[2] ? r[2].toLowerCase() : '';
        return staffName.includes(name) && reportDate >= start && reportDate <= end;
    });

    const reportObjects = results.map(r => createReportObject(r));
    appState.viewableReports = reportObjects; 
    
    const tableBody = document.querySelector('#historyTable tbody');
    if (results.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#777;">या निकषात कोणताही अहवाल सापडला नाही.</td></tr>`;
    } else {
        tableBody.innerHTML = reportObjects.map((r, index) => `<tr><td>${r.date}</td><td>${r.name}</td><td><span class="clickable" onclick="viewReport(${index})">वाचा</span></td></tr>`).join('');
    }
}

// --- INITIAL LOAD ---
google.charts.setOnLoadCallback(loadDashboard);
</script>

</body>
</html>
