<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anik Finance - Operational Dashboard</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --anik-blue: #0056b3; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b;
            --bg: #f4f7fa; --card: #ffffff; --text: #1e293b; --text-light: #64748b;
            --ca-color: #6366f1; --fx-color: #ec4899; --bm-color: #f97316; --ta-color: #14b8a6;
        }
        body { font-family: 'Inter', 'Noto Sans Devanagari', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .logo { max-width: 180px; height: auto; }
        .container { max-width: 1250px; margin: 25px auto; padding: 0 20px; }

        /* Filters */
        .filter-bar { background: white; padding: 20px; border-radius: 16px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 180px; }
        label { font-size: 12px; font-weight: 700; color: var(--anik-blue); text-transform: uppercase; }
        input, select, button { padding: 12px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 14px; outline: none; }
        button { background: var(--anik-blue); color: white; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; }
        button:hover { background: #004494; transform: translateY(-2px); }

        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 22px; border-radius: 18px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; border-bottom: 4px solid #ddd; }
        .kpi-card:hover { transform: translateY(-5px); }
        .kpi-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .kpi-val { font-size: 26px; font-weight: 700; margin: 0; color: var(--anik-blue); }
        .kpi-label { font-size: 13px; color: var(--text-light); font-weight: 600; }

        /* Role Cards */
        .role-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .role-card { background: white; padding: 20px; border-radius: 15px; text-align: center; border-top: 5px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.04); cursor: pointer; }
        .role-card h4 { margin: 0 0 10px; font-size: 13px; color: var(--text-light); text-transform: uppercase; }
        .role-card .count { font-size: 22px; font-weight: 700; }

        /* Tables & Layout */
        .main-layout { display: grid; grid-template-columns: 1.6fr 1fr; gap: 25px; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 18px; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8fafc; font-size: 12px; color: var(--text-light); }
        td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .view-btn { color: var(--anik-blue); cursor: pointer; font-weight: 700; text-decoration: underline; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 0; border-radius: 16px; width: 95%; max-width: 700px; position: relative; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f8fafc; }
        .detail-label { color: var(--text-light); font-size: 13px; flex: 1; }
        .detail-value { font-weight: 600; flex: 1; text-align: right; }
        .close { font-size: 28px; cursor: pointer; color: var(--text-light); }
        .report-block { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>

<header>
    <img src="https://anikfin.com/wp-content/uploads/2024/06/anik-horizontal-1-1024x400.png" class="logo">
</header>

<div class="container">
    <div class="filter-bar">
        <div class="filter-group">
            <label>‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§®‡§ø‡§µ‡§°‡§æ (Date)</label>
            <input type="date" id="reportDate" onchange="processData()">
        </div>
        <div class="filter-group">
            <label>‡§∂‡§æ‡§ñ‡§æ (Branch)</label>
            <select id="unitSelect" onchange="processData()">
                <option value="ALL">‡§∏‡§∞‡•ç‡§µ ‡§∂‡§æ‡§ñ‡§æ</option>
            </select>
        </div>
        <button onclick="loadData()">üîÑ ‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂ ‡§°‡•á‡§ü‡§æ</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card" style="border-bottom-color: var(--anik-blue);" onclick="showStatusList('ALL')">
            <div class="kpi-icon" style="background: rgba(0,86,179,0.1); color: var(--anik-blue);">üë•</div>
            <div><p class="kpi-val" id="kTotalStaff">0</p><p class="kpi-label">‡§è‡§ï‡•Ç‡§£ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä</p></div>
        </div>
        <div class="kpi-card" style="border-bottom-color: var(--success);" onclick="showStatusList('SUBMITTED')">
            <div class="kpi-icon" style="background: #dcfce7; color: var(--success);">‚úÖ</div>
            <div><p class="kpi-val" id="kTotalSub">0</p><p class="kpi-label">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§</p></div>
        </div>
        <div class="kpi-card" style="border-bottom-color: var(--danger);" onclick="showStatusList('PENDING')">
            <div class="kpi-icon" style="background: #fee2e2; color: var(--danger);">‚è≥</div>
            <div><p class="kpi-val" id="kTotalPen">0</p><p class="kpi-label">‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§ (Pending)</p></div>
        </div>
        <div class="kpi-card" style="background: var(--anik-blue); color: white; border: none;">
            <div class="kpi-icon" style="background: rgba(255,255,255,0.2); color: white;">üìà</div>
            <div><p class="kpi-val" id="kPerc" style="color: white;">0%</p><p class="kpi-label" style="color: rgba(255,255,255,0.7);">‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§ø‡§Ç‡§ó %</p></div>
        </div>
    </div>

    <div class="role-grid">
        <div class="role-card" style="border-top-color: var(--ca-color);" onclick="showRoleStatus('CA')">
            <h4>CA (‡§ï‡•ç‡§∞‡•á‡§°‡§ø‡§ü ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡§Ç‡§ü)</h4><div class="count" id="rCA" style="color: var(--ca-color);">0/0</div>
        </div>
        <div class="role-card" style="border-top-color: var(--fx-color);" onclick="showRoleStatus('FX')">
            <h4>FX (‡§´‡•Ä‡§≤‡•ç‡§° ‡§è‡§ï‡•ç‡§ù‡§ø‡§ï‡•ç‡§Ø‡•Å‡§ü‡§ø‡§µ‡•ç‡§π)</h4><div class="count" id="rFX" style="color: var(--fx-color);">0/0</div>
        </div>
        <div class="role-card" style="border-top-color: var(--bm-color);" onclick="showRoleStatus('BM')">
            <h4>BM (‡§∂‡§æ‡§ñ‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï)</h4><div class="count" id="rBM" style="color: var(--bm-color);">0/0</div>
        </div>
        <div class="role-card" style="border-top-color: var(--ta-color);" onclick="showRoleStatus('TA')">
            <h4>TA (‡§Ö‡§ï‡§æ‡§ä‡§Ç‡§ü‡§Ç‡§ü)</h4><div class="count" id="rTA" style="color: var(--ta-color);">0/0</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="card">
            <h3>üìë ‡§Ü‡§ú‡§ö‡•á ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§Ö‡§π‡§µ‡§æ‡§≤ (Submitted)</h3>
            <div style="overflow-x: auto;">
                <table id="subTable">
                    <thead><tr><th>‡§®‡§æ‡§µ</th><th>‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ</th><th>‡§∂‡§æ‡§ñ‡§æ</th><th>‡§π‡§æ‡§Ø‡§≤‡§æ‡§à‡§ü</th><th>‡§§‡§™‡§∂‡•Ä‡§≤</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h3>‚è≥ ‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§Ø‡§æ‡§¶‡•Ä (Pending List)</h3>
            <div id="piechart" style="width:100%; height:180px"></div>
            <table id="penTable">
                <thead><tr><th>‡§®‡§æ‡§µ</th><th>‡§∂‡§æ‡§ñ‡§æ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle" style="margin:0; border:none; padding:0;">‡§§‡§™‡§∂‡•Ä‡§≤</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
const API_KEY = "AIzaSyCib9D8dkRRV7MyGDfTcCqaubl19RnCdhQ";
const SHEET_ID = "1--ve2YhfEwX-ZddBQr2nT-lxShvmdgczD6szJrii0wg";

// Column Configurations for Easy Updates
const SCHEMA = {
    BM: ["Timestamp", "‡§§‡§æ‡§∞‡•Ä‡§ñ", "‡§®‡§æ‡§µ", "‡§Ø‡•Å‡§®‡§ø‡§ü", "‡§∞‡§ú‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä", "BM Acc", "BM Amt", "BM Cash", "BM Digi", "OD1_C", "OD1_A", "OD2_C", "OD2_A", "OD3_C", "OD3_A", "Disb_Cust", "Disb_Amt", "Autopay", "Appr_Total", "Appr_Sanc", "Appr_Rej", "Meets", "Notes", "Cash_Note", "Imp_Note"],
    FX: ["Timestamp", "‡§§‡§æ‡§∞‡•Ä‡§ñ", "‡§®‡§æ‡§µ", "‡§Ø‡•Å‡§®‡§ø‡§ü", "‡§∞‡§ú‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä", "CA ‡§®‡§æ‡§µ", "Ac", "Amt", "Cash", "Digi", "null", "H_Cash", "H_Why", "OD_Ac", "OD_Amt", "Auto_Done", "P5_Acc", "P5_Amt", "P6_Cnt", "P6_Rej", "Appr_Done", "Appr_Pen", "Village", "Notes", "Complaints"],
    CA: ["Timestamp", "‡§§‡§æ‡§∞‡•Ä‡§ñ", "‡§®‡§æ‡§µ", "‡§Ø‡•Å‡§®‡§ø‡§ü", "‡§∞‡§ú‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä", "Reg_C", "Reg_A", "OD_C", "OD_A", "Past_C", "Past_A", "Meets", "Village", "KYC", "Forms", "Forms_Pen", "Auto_Done", "Issues"],
    TA: ["Timestamp", "‡§§‡§æ‡§∞‡•Ä‡§ñ", "‡§®‡§æ‡§µ", "‡§Ø‡•Å‡§®‡§ø‡§ü", "‡§∞‡§ú‡§æ ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä", "Report_Cnt", "Coll_Match", "Cash_Hand", "Bank_Depo", "Depo_Reason", "Fin_Sys_Date", "SPMB_Date", "All_CA_Rec", "CA_Pending", "New_OD", "OD_Amt", "EMI_Act", "EMI_Fail", "Rec_Track", "Notes", "Declaration"]
};

document.getElementById('reportDate').valueAsDate = new Date();

let store = { staff: [], ca: [], fx: [], bm: [], ta: [], currentSubNames: [], currentStaffList: [] };
google.charts.load('current', {'packages':['corechart']});

async function fetchValues(tab) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${tab}?key=${API_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.values || [];
}

async function loadData() {
    try {
        const [s, c, f, b, t] = await Promise.all([
            fetchValues("Staff_Data"), fetchValues("CA_Reports"),
            fetchValues("FX_Reports"), fetchValues("BM_Reports"), fetchValues("TA_Reports")
        ]);
        store.staff = s.slice(1);
        store.ca = c.slice(1);
        store.fx = f.slice(1);
        store.bm = b.slice(1);
        store.ta = t.slice(1);

        const units = [...new Set(store.staff.map(r => r[2]))].filter(Boolean).sort();
        const sel = document.getElementById('unitSelect');
        sel.innerHTML = '<option value="ALL">‡§∏‡§∞‡•ç‡§µ ‡§∂‡§æ‡§ñ‡§æ</option>';
        units.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);

        processData();
    } catch (e) { console.error("Data Load Error:", e); }
}

function normalizeDate(d) {
    if (!d) return "";
    let clean = d.split(' ')[0].trim();
    if (clean.includes('/')) {
        const [day, mon, year] = clean.split('/');
        return `${year}-${mon.padStart(2,'0')}-${day.padStart(2,'0')}`;
    }
    return clean;
}

function processData() {
    const targetDate = document.getElementById('reportDate').value; 
    const unit = document.getElementById('unitSelect').value;
    const filter = (r) => normalizeDate(r[1]) === targetDate && (unit === "ALL" || r[3] === unit);

    const dCA = store.ca.filter(filter);
    const dFX = store.fx.filter(filter);
    const dBM = store.bm.filter(filter);
    const dTA = store.ta.filter(filter);
    const dStaff = store.staff.filter(s => unit === "ALL" || s[2] === unit);

    store.currentStaffList = dStaff;
    updateDashboard(dCA, dFX, dBM, dTA, dStaff);
}

function updateDashboard(ca, fx, bm, ta, staff) {
    // Group FX reports by name (one person might submit multiple rows for different CAs)
    const fxGrouped = {};
    fx.forEach(row => {
        const name = row[2].trim();
        if (!fxGrouped[name]) fxGrouped[name] = [];
        fxGrouped[name].push(row);
    });

    const subNames = [...new Set([
        ...ca.map(r=>r[2].trim()), 
        ...Object.keys(fxGrouped), 
        ...bm.map(r=>r[2].trim()),
        ...ta.map(r=>r[2].trim())
    ])];
    
    store.currentSubNames = subNames;
    const subCount = subNames.length;
    const penCount = staff.length - subCount;

    document.getElementById('kTotalStaff').innerText = staff.length;
    document.getElementById('kTotalSub').innerText = subCount;
    document.getElementById('kTotalPen').innerText = penCount;
    document.getElementById('kPerc').innerText = (staff.length > 0 ? Math.round((subCount/staff.length)*100) : 0) + "%";

    // Role Stats
    const roles = ['CA', 'FX', 'BM', 'TA'];
    const dataSets = { CA: ca, FX: Object.keys(fxGrouped), BM: bm, TA: ta };

    roles.forEach(role => {
        const total = staff.filter(s => s[1].trim() === role).length;
        let submitted = 0;
        if (role === 'FX') {
            submitted = dataSets.FX.filter(name => staff.some(s => s[0].trim() === name && s[1] === 'FX')).length;
        } else {
            submitted = dataSets[role].length;
        }
        document.getElementById(`r${role}`).innerText = `${submitted} / ${total}`;
    });

    // Sub Table
    const tbody = document.querySelector('#subTable tbody');
    tbody.innerHTML = "";
    
    ca.forEach(r => tbody.innerHTML += renderRow(r[2], 'CA', r[3], `‡§µ‡§∏‡•Å‡§≤‡•Ä: ‚Çπ${r[6] || 0}`, [r]));
    Object.keys(fxGrouped).forEach(name => {
        const rows = fxGrouped[name];
        tbody.innerHTML += renderRow(name, 'FX', rows[0][3], `CA ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ: ${rows.length}`, rows);
    });
    bm.forEach(r => tbody.innerHTML += renderRow(r[2], 'BM', r[3], `‡§µ‡§æ‡§ü‡§™: ‚Çπ${r[16] || 0}`, [r]));
    ta.forEach(r => tbody.innerHTML += renderRow(r[2], 'TA', r[3], `‡§ï‡•Ö‡§∂: ‚Çπ${r[7] || 0}`, [r]));

    // Pending Table
    const pt = document.querySelector('#penTable tbody');
    pt.innerHTML = "";
    staff.forEach(s => {
        if (!subNames.includes(s[0].trim())) pt.innerHTML += `<tr><td>${s[0]}</td><td>${s[2]}</td></tr>`;
    });

    drawChart(subCount, penCount);
}

function renderRow(name, role, unit, highlight, data) {
    return `<tr>
        <td><b>${name}</b></td>
        <td><span style="color:var(--${role.toLowerCase()}-color); font-weight:700">${role}</span></td>
        <td>${unit}</td>
        <td>${highlight}</td>
        <td><span class="view-btn" onclick='showDetails("${role}", ${JSON.stringify(data)})'>‡§™‡§π‡§æ</span></td>
    </tr>`;
}

function showDetails(role, entries) {
    const labels = SCHEMA[role];
    let html = "";

    entries.forEach((row, index) => {
        html += `<div class="report-block">
            <div style="font-weight:700; color:var(--anik-blue); margin-bottom:10px; border-bottom:1px solid #ddd;">
                ‡§Ö‡§π‡§µ‡§æ‡§≤ #${index + 1} (${row[4] || 'N/A'})
            </div>`;
        
        labels.forEach((label, i) => {
            if(i < 2 || label === "null") return; // Skip timestamp/date/null
            html += `<div class="detail-row">
                <span class="detail-label">${label}</span>
                <span class="detail-value">${row[i] || '-'}</span>
            </div>`;
        });
        html += `</div>`;
    });

    openModal(`${entries[0][2]} - ${role} ‡§Ö‡§π‡§µ‡§æ‡§≤ ‡§§‡§™‡§∂‡•Ä‡§≤`, html);
}

function showRoleStatus(role) {
    const staff = store.currentStaffList.filter(s => s[1].trim() === role);
    let html = "<div>";
    staff.forEach(s => {
        const isSub = store.currentSubNames.includes(s[0].trim());
        html += `<div class="detail-row">
            <span>${isSub ? '‚úÖ' : '‚ùå'} <b>${s[0]}</b></span>
            <span style="color:${isSub ? 'var(--success)' : 'var(--danger)'}">${isSub ? '‡§∏‡§¨‡§Æ‡§ø‡§ü' : '‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§'}</span>
        </div>`;
    });
    openModal(`${role} ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä`, html + "</div>");
}

function showStatusList(type) {
    let title = type === 'SUBMITTED' ? "‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡•á‡§≤‡•á‡§≤‡•á ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä" : (type === 'PENDING' ? "‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä" : "‡§∏‡§∞‡•ç‡§µ ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä");
    let html = "<div>";
    store.currentStaffList.forEach(s => {
        const isSub = store.currentSubNames.includes(s[0].trim());
        if (type === 'ALL' || (type === 'SUBMITTED' && isSub) || (type === 'PENDING' && !isSub)) {
            html += `<div class="detail-row">
                <span>${isSub ? '‚úÖ' : '‚ùå'} <b>${s[0]}</b> (${s[1]})</span>
                <span style="font-size:12px; color:var(--text-light)">${s[2]}</span>
            </div>`;
        }
    });
    openModal(title, html + "</div>");
}

function openModal(title, body) {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('statusModal').style.display = 'block';
}

function closeModal() { document.getElementById('statusModal').style.display = 'none'; }

function drawChart(s, p) {
    const data = google.visualization.arrayToDataTable([['Status', 'Count'], ['‡§∏‡§¨‡§Æ‡§ø‡§ü', s], ['‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§', p]]);
    new google.visualization.PieChart(document.getElementById('piechart')).draw(data, {
        pieHole: 0.6, colors: ['#22c55e', '#f1f5f9'], legend: 'none', chartArea: {width:'90%', height:'90%'}
    });
}

window.onclick = (event) => { if (event.target == document.getElementById('statusModal')) closeModal(); }
google.charts.setOnLoadCallback(loadData);
</script>
</body>
</html>
